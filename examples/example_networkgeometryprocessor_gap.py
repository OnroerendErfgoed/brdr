import numpy as np

from brdr.aligner import Aligner
from brdr.be.grb.enums import GRBType
from brdr.be.grb.loader import GRBActualLoader
from brdr.configs import ProcessorConfig
from brdr.enums import AlignerResultType
from brdr.geometry_utils import geom_from_wkt
from brdr.loader import DictLoader
from brdr.processor import (
    DieussaertGeometryProcessor,
)
from brdr.viz import plot_difference_by_relevant_distance, show_map

wkt = "MULTIPOLYGON (((173728.58569999999599531 175608.02299999998649582, 173728.70929999998770654 175622.29250000001047738, 173728.95600000000558794 175650.76500000001396984, 173729.17339999999967404 175673.91399999998975545, 173729.20060000001103617 175676.8037999999942258, 173729.48250000001280569 175706.81390000000828877, 173729.67610000001150183 175727.42590000000200234, 173729.75800000000162981 175736.15049999998882413, 173730.1780000000144355 175780.86499999999068677, 173729.89949999999953434 175780.86770000000251457, 173730.04579999999259599 175803.27280000000610016, 173730.14770000000135042 175818.89929999999003485, 173730.19729999999981374 175826.49679999999352731, 173730.19860000000335276 175826.68109999998705462, 173730.50500000000465661 175873.64499999998952262, 173730.52079999999841675 175879.04000000000814907, 173730.56219999998575076 175893.16920000000391155, 173730.57500000001164153 175897.55100000000675209, 173720.40640000000712462 175897.48060000000987202, 173711.44980000000214204 175897.41870000000926666, 173711.53440000000409782 175904.04199999998672865, 173711.60399999999208376 175909.48840000000200234, 173711.68210000000544824 175915.60079999998561107, 173711.75839999999152496 175921.57519999999203719, 173711.83720000000903383 175927.74150000000372529, 173711.87580000000889413 175930.76290000000153668, 173711.91269999998621643 175933.65289999998640269, 173711.98989999998593703 175939.69430000000284053, 173712.06260000000474975 175945.38279999999213032, 173712.14519999999902211 175951.84909999999217689, 173712.18160000001080334 175954.70139999999082647, 173725.27520000000367872 175952.26279999999678694, 173725.42689999999129213 175952.23449999999138527, 173724.96849999998812564 175952.74410000001080334, 173719.55050000001210719 175960.15030000000842847, 173664.64799999998649582 175960.2920999999914784, 173646.04050000000279397 175960.34030000001075678, 173645.94039999999222346 175914.0801999999966938, 173601.87810000000172295 175914.44180000000051223, 173601.37690000000293367 175914.1344999999855645, 173604.09690000000409782 175907.9345000000030268, 173609.83689999999478459 175882.60449999998672865, 173610.43059999999240972 175882.59919999999692664, 173610.28270000001066364 175842.93189999999594875, 173610.23300000000745058 175829.59169999998994172, 173610.19440000000759028 175819.22779999999329448, 173610.19250000000465661 175818.7447999999858439, 173617.20420000000740401 175803.46299999998882413, 173622.82360000000335276 175791.21539999998640269, 173628.55879999999888241 175778.71549999999115244, 173639.21760000000358559 175755.48490000001038425, 173642.61960000000544824 175748.07000000000698492, 173645.54610000000684522 175741.69180000000051223, 173648.27590000000782311 175735.74210000000311993, 173653.38469999999506399 175724.6075999999884516, 173654.15690000000176951 175722.9253000000026077, 173664.50399999998626299 175712.92089999999734573, 173667.62479999999050051 175709.90359999999054708, 173670.18690000000060536 175707.42629999999189749, 173671.18590000001131557 175698.50529999998980202, 173673.36689999999362044 175679.87530000001424924, 173675.42689999999129213 175659.52530000000842847, 173675.57689999998547137 175654.24530000000959262, 173675.14790000001084991 175647.64530000000377186, 173673.9375 175644.70650000000023283, 173673.65690000000176951 175644.02530000000842847, 173677.17739999998593703 175641.71109999998589046, 173677.63190000000759028 175641.41149999998742715, 173680.86689999999362044 175639.28450000000884756, 173696.11689999999362044 175625.09450000000651926, 173716.92689999999129213 175609.81450000000768341, 173725.95639999999548309 175608.42699999999604188, 173728.58569999999599531 175608.02299999998649582)))"
dict_theme = {"id_wkt": geom_from_wkt(wkt)}
config = ProcessorConfig()
# config.od_strategy = OpenDomainStrategy.EXCLUDE
processor = DieussaertGeometryProcessor(config=config)
# processor = NetworkGeometryProcessor(config=config)
# processor = SnapGeometryProcessor(config=config)
aligner = Aligner(crs="EPSG:31370", processor=processor)
loader = DictLoader(dict_theme)
aligner.load_thematic_data(loader)
loader = GRBActualLoader(grb_type=GRBType.ADP, partition=1000, aligner=aligner)
aligner.load_reference_data(loader)

series = np.arange(0, 310, 10, dtype=int) / 100
# predict which relevant distances are interesting to propose as resulting geometry
aligner_result = aligner.predict(
    relevant_distances=series,
)
# aligner_result = aligner.process(relevant_distances=[0,1,2,3,4],)
# aligner_result = aligner.process(relevant_distances=[2],)
dict_predictions = aligner_result.get_results(
    aligner=aligner, result_type=AlignerResultType.PREDICTIONS
)

# SHOW results of the predictions
fcs = aligner_result.get_results_as_geojson(add_metadata=False, aligner=aligner)
diffs_dict = aligner.get_difference_metrics_for_thematic_data(
    dict_processresults=aligner_result.results, thematic_data=aligner.thematic_data
)
reference_geometries = {
    key: feat.geometry for key, feat in aligner.reference_data.features.items()
}
if fcs is None or "result" not in fcs:
    print("empty predictions")
else:
    print(fcs["result"])
    for key in dict_predictions:
        plot_difference_by_relevant_distance({key: diffs_dict[key]})
        show_map(
            {key: dict_predictions[key]},
            {key: aligner.thematic_data.features[key].geometry},
            reference_geometries,
        )
