from matplotlib import pyplot as plt
from shapely.geometry import Polygon
from shapely.geometry.multipoint import MultiPoint
from shapely.ops import nearest_points

from brdr.geometry_utils import get_coords_from_geometry, geom_from_wkt


def plot_polygons(poly_reference, poly_input, edge_matched_poly):
    fig, ax = plt.subplots()

    # Plot original polygons
    x1, y1 = poly_reference.exterior.xy
    ax.plot(x1, y1, "b--", label="reference")

    x2, y2 = poly_input.exterior.xy
    ax.plot(x2, y2, "r--", label="Polygon 2")


    x3, y3 = edge_matched_poly.exterior.xy
    ax.plot(x3, y3, "g--", label="Polygon edgematched")
    # # Plot edge-matched polygon
    # for geom in edge_matched_poly.geoms:
    #     x3, y3 = geom.exterior.xy
    #     ax.plot(x3, y3, "g--", label="Edge-matched Polygon")

    ax.legend()
    plt.show()

def trace_polygon(reference_poly, start_point, end_point):
    # Ensure the start and end points are on the boundary of the reference polygon
    reference_coords = MultiPoint(list(get_coords_from_geometry(reference_poly)))
    start_point = nearest_points(start_point, reference_coords)[1]
    end_point = nearest_points(end_point, reference_coords)[1]

    # Get the coordinates of the reference polygon boundary
    boundary_coords = list(reference_poly.boundary.coords)

    # Find the indices of the start and end points in the boundary coordinates
    start_index = boundary_coords.index((start_point.x, start_point.y))
    end_index = boundary_coords.index((end_point.x, end_point.y))

    # Trace the boundary from start to end point
    if start_index < end_index:
        trace_coords = boundary_coords[start_index:end_index + 1]
    else:
        trace_coords = boundary_coords[start_index:] + boundary_coords[:end_index + 1]

    if len(trace_coords)<3:
        return Polygon()
    # Create a new polygon from the traced coordinates
    traced_polygon = Polygon(trace_coords)

    return traced_polygon


# Example usage
reference_poly = geom_from_wkt("Polygon ((174154.92303594946861267 179318.49081455171108246, 174154.9213719516992569 179318.4739825502038002, 174154.86018794775009155 179318.47980654984712601, 174149.13545194268226624 179319.02489455044269562, 174139.65033193677663803 179319.9280625507235527, 174142.27721194177865982 179346.19692657142877579, 174142.83721194416284561 179351.79692657291889191, 174145.94620393961668015 179382.88659059628844261, 174146.28028394281864166 179382.79699059575796127, 174158.07279594987630844 179379.63436659425497055, 174160.79900395125150681 179378.90323059260845184, 174154.92303594946861267 179318.49081455171108246))")
start_point = geom_from_wkt("Point(174125.66583829143201001 179320.36133541050367057)")
end_point = geom_from_wkt("Point(174162.76793666195590049 179378.37517146224854514)")
input_poly = geom_from_wkt("Polygon ((174125.66583829143201001 179320.36133541050367057, 174125.66583829294540919 179320.36133543887990527, 174123.56114244047785178 179320.47114562886417843, 174123.60579274909105152 179320.9312379399780184, 174123.65622600910137407 179321.4509197928418871, 174130.00431616476271302 179386.86384879014804028, 174131.20465914410306141 179386.55606853921199217, 174131.47325675669708289 179386.48719735653139651, 174131.4777007331722416 179386.48605787538690493, 174131.48166125148418359 179386.48504236005828716, 174131.56964346842141822 179386.46248281505540945, 174145.93543933291221038 179382.77894541397108696, 174153.73543597472598776 179380.77894627506611869, 174155.22223844396648929 179380.39771487266989425, 174155.31905292189912871 179380.37289064755896106, 174158.08159073328715749 179379.66454761903150938, 174162.78046076380996965 179378.45970914987265132, 174162.77348954943590797 179378.41265345277497545, 174162.76924267943832092 179378.38398708027671091, 174162.76793666195590049 179378.37517146224854514, 174158.29825295542832464 179348.20480644324561581, 174158.06896705977851525 179348.24847994712763466, 174157.82196880917763337 179348.29552723292727023, 174152.4153556079545524 179349.32535831883433275, 174151.38357602406176738 179340.0393457512545865, 174150.45438929076772183 179331.6766651498619467, 174155.32298101272317581 179329.59012584027368575, 174155.97540604253299534 179329.31051516399020329, 174156.06587580699124373 179329.27174254972487688, 174156.3372870393213816 179329.15542325720889494, 174155.77701106332824565 179318.79031770044821315, 174154.96588003114447929 179318.83263741704286076, 174154.95658402171102352 179318.83312241756357253, 174151.97826524809352122 179318.98851313433260657, 174146.5353382924804464 179319.27249193197349086, 174125.66583829143201001 179320.36133541050367057))")

traced_poly = trace_polygon(reference_poly, start_point, end_point)

print("Reference Polygon:", reference_poly)
print("Traced Polygon:", traced_poly)

plot_polygons(reference_poly,input_poly,traced_poly)
